Tileskymap.py reads in single/multiple skymaps and attempts to provide 
the best tiling layout using a 'greedy tile' strategy. The version
here is designed for use during the early stages of Advanced LIGO/VIRGO
using the GOTO prototype observatory. 

The user can choose a range of options, such as tiling with galaxy 
weighting, or selecting between the two GOTO configurations (4- and
8-astrograph designs).

Output is in the form of a list of tiles, ordered by probability,
as well as optional plots (geocentric, or celestial).

Pre-requisites:
===============

Before installing additional pre-requisite modules, please ensure that
the `numpy` package is installed. Using the ``pip`` command below will
automatically do this as the first step for you.
    
The remaining modules required for GOTO-tile to work can be found in
the `requirements.txt` file. Two dependencies are not found in the
regular spot: `basemap` and `spherical-geometry` (there is a `basemap`
listed when using ``pip search basemap``, but this is an outdated
version).

The easiest way to install all requirements is:

    $ pip install -r requirements.txt
    

Note that basemap requires the geos C library, which is usually found
in package managers as `libgeos-dev` or `libgeos-devel`.


Known issues: 

For python3 installations, pip install healpy does not seem to build/install
the internal healpix libraries (but seems to work fine for python 2.7). This
can be fixed by manually installing the healpix_cxx libraries 
(http://sourceforge.net/projects/healpix/files/Healpix_3.11/autotools_packages)

Installation:
=============

Installation can be done using the standard python setup.py install command.
This will place the tileskymap executable in your path, and allow import
of gototile modules in other python scripts.

Post-install:
=============

In order to tile the sky, we must first create the list of fixed tiles,
in a given directory. This speeds up the time taken to tile a given skymap.
This can be done by running:

	$ tileskymap --makegrid
	
with a user chosen directory:

	$ tileskymap --makegrid --tiles <path-to-tiles>


Running skymaptile.py
======================

The basic method for calling the script with default settings is:

	$ tileskymap <skymap-file>

A list of user-changeable options can be found using:

    $ tileskymap -h

Output:-

usage: tileskymap [-h] [-i ID] [-p PATH] [--maxtiles MAXTILES]
                  [--maxfrac MAXFRAC] [--minfrac MINFRAC] [-s {g4,g8,swn}]
                  [--site SITE SITE SITE] [--fov FOV FOV] [-g] [-n]
                  [-d [DATE]] [--geoplot] [--plot] [--title TITLE]
                  [--makegrid] [--tiles TILES] [--object OBJECT OBJECT OBJECT]
                  [--sun] [--moon] [--sim] [--injgal] [--simpath SIMPATH]
                  [infiles [infiles ...]]

This script creates pointings for selected telescopes, with given skymap
files.

positional arguments:
  infiles               Space separated input files (default: None)

optional arguments:
  -h, --help            show this help message and exit
  -i ID, --id ID        Name of output files (without extension) (default: )
  -p PATH, --path PATH  Output path (default: ./)
  --maxtiles MAXTILES   Maximum number of tiles to return (default: 100)
  --maxfrac MAXFRAC     Maximum fraction of visible skymap to tile (default:
                        0.95)
  --minfrac MINFRAC     Minimum fraction of visible skymap required to attempt
                        tiling (default: 0.05)
  -s {g4,g8,swn}, --scope {g4,g8,swn}
                        Telescope to use. GOTO-4, GOTO-8, SuperWASP-North.
                        (default: g4)
  --site SITE SITE SITE
                        Set the longitude, latitude and elevation. Overrides
                        the defaults from the 'scope' setting. (default: None)
  --fov FOV FOV         Set the width (RA) and height (dec) of the field of
                        view, in degrees. Overrides the default from the
                        'scope' setting. (default: None)
  -g, --usegals         Use GWGC in tiling/plotting (default: False)
  -n, --nightsky        Use nightsky visbility in tiling/plotting (default:
                        False)
  -d [DATE], --date [DATE]
                        Set observation date. If not used, defaults to the
                        current date. If given without argument, defaults to
                        the trigger date in the input file(s). The optional
                        argument can be a date-time string that can be parsed
                        by astropy.time.Time, such as '2012-12-12T12:12:12'. A
                        single number is interpreted as Julian days; use a
                        number with 'mjd' appended to specify Modified Julian
                        Days. (default: now)
  --geoplot             Plot in geographic coordinates, (lat, lon) (default:
                        False)
  --plot                Plot in RA-Dec (default: False)
  --title TITLE         Use suppied title in skymap plot. (default: None)
  --makegrid            Create fixed grid of tiles on sky. WARNING: Can take
                        some time. (default: False)
  --tiles TILES         Location of pre-made fixed grid of tiles on sky.
                        (default: ./tiles/)
  --object OBJECT OBJECT OBJECT
                        Overplot an object. Requires three values: RA, Dec and
                        an object name. (default: [])
  --sun                 Plot the Sun position (default: False)
  --moon                Plot the Moon position (default: False)
  --sim                 A first2years simulation. Check tiles for known
                        position of source. (default: False)
  --injgal              Inject galaxy at location in f2y map. Take into
                        account known position and distance. (default: False)
  --simpath SIMPATH     Path to folder of Skymaps, organised into folders by
                        year. (default: ./Skymaps)
                        
An example command might be:

tileskymap -i 10206 -p allskyinjgal -s g4 --sim --simpath /storage/astro2/phsnap/LIGO/Skymaps --object 64.9 42.2 10206 --date  --plot --injgal --usegals /storage/astro2/phsnap/LIGO/Skymaps/2015_fits/10206/bayestar.fits.gz

Notes:
    Currently the script assumes greedy tiling is required. However, this may
    be sub-optimal given the large filed-of-view of GOTO, and poor pointing
    from the GW detectors, particularly in the 2-detector scenario, and is
    an avenue of future work.
    
Running f2ytile
================

The script f2ytile is essentially a wrapper around the tileskymap script, that
allows the user to run the tiling algorith across the first2years simulated
skymaps produced by Singer et al. (http://www.ligo.org/scientists/first2years/).
The usage and list of user-configurable options are:
  
usage: f2ytile [-h] [--simpath SIMPATH] [--out OUT] [--log LOG]
               [--years YEARS] [--scopes SCOPES] [-d [DATE]] [--args ARGS]

This script creates pointings for selected telescopes, with given skymap
files.

optional arguments:
  -h, --help            show this help message and exit
  --simpath SIMPATH     Input folder containing groups of maps (e.g. by year)
                        (default: ./)
  --out OUT             Output folder for plots and text files (default: None)
  --log LOG             Output log file name (default: f2ytile.log)
  --years YEARS         Folder names within input folder containing simulated
                        maps, comma separated. (default: 2015,2016)
  --scopes SCOPES       Telescope variations to use for tiling, comma
                        separated (default: g4,g8)
  -d [DATE], --date [DATE]
                        Set observation date. If not used, defaults to the
                        current date. If given without argument, defaults to
                        the trigger date in the input file(s). The optional
                        argument can be a date-time string that can be parsed
                        by astropy.time.Time, such as '2012-12-12T12:12:12'. A
                        single number is interpreted as Julian days; use a
                        number with 'mjd' appended to specify Modified Julian
                        Days. (default: now)
  --args ARGS           Additional arguments to be passed to tileskymap (e.g.
                        --plot, --geoplot, --nightsky (default: )

With an example command of:

f2ytile --out nightskyinjgal --log nightskyinjgal.log --years 2015 --scopes g4 --simpath /storage/astro2/phsnap/LIGO/Skymaps --date --args "--plot --injgal --usegals --nightsky"

Notes:
    The script allows users to provide all extra flags to the tileskymap script
    using the --args option. The options to be passed must be contained within
    quotes. If only one option is passed, for example to plot, then a space must
    be added at the end. For example: --args "--plot ". This is a bug that I 
    have not been able to figure out just yet.
    
Running postmap
===============

The postmap script is included to generate plots, combined data and basic
statistics on the tiles generated by f2ytile. 

usage: postmap [-h] [--first] [--out OUT] [--tiles TILES] [--simpath SIMPATH]
               [--lc LC] [-s {g4,g8,swn}] [--tiledists] [--injdists]
               [--visible] [--mags] [--maglim MAGLIM] [--exptime EXPTIME]
               [-d [DATE]]

This script creates pointings for selected telescopes, with given skymap
files.

optional arguments:
  -h, --help            show this help message and exit
  --first               Make tilefiles? (default: False)
  --out OUT             Output folder for plots and text files (default: None)
  --tiles TILES         Location of f2y tiling algorithm output (default: ./)
  --simpath SIMPATH     Input folder containing original first2years
                        simulations (default: /storage/astro2/phsnap/Skymaps)
  --lc LC               Input folder containing kilonova lightcurve
                        simulations (default: /storage/astro2/phsnap/lightcurv
                        es/GOTO/ns_merger_mags/)
  -s {g4,g8,swn}, --scope {g4,g8,swn}
                        Telescope to use. GOTO-4, GOTO-8, SuperWASP-North.
                        (default: g4)
  --tiledists           Find angular distances between successive tiles
                        (default: False)
  --injdists            Find angular distances between injection location and
                        loudest pixel (default: False)
  --visible             Check number of injections above horizon (default:
                        False)
  --mags                Check number of injections above limiting mag
                        (default: False)
  --maglim MAGLIM       Limiting magnitude above which kilonova is visible
                        (default: 21.0)
  --exptime EXPTIME     Exposure time in mins of observations (used for
                        working out total time for all tiles) (default: 5.0)
  -d [DATE], --date [DATE]
                        Set observation date. If not used, defaults to the
                        current date. If given without argument, defaults to
                        the trigger date in the input file(s). The optional
                        argument can be a date-time string that can be parsed
                        by astropy.time.Time, such as '2012-12-12T12:12:12'. A
                        single number is interpreted as Julian days; use a
                        number with 'mjd' appended to specify Modified Julian
                        Days. (default: now)

An example command to produce output from the example f2ytile command above: 

postmap -s g4 --tiledists --injdists --visible --mags --simpath /storage/astro2/phsnap/LIGO/Skymaps --tiles nightskyinjgal --out nightskyinjgal/postmap --date --first
    
